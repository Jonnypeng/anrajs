config = [
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
];

/*图片SIZE*/
IMAGE_WIDTH = 1024;
IMAGE_HEIGHT = 1024;
/*帧率*/
FRAME_RATE = 15;
ITEM_IMAGE = "images/anime/move5.png";
/*角色运动速度*/
PLAYER_SPEED = 4;
/*角色运动速度*/
PLAYER_SPACE = 0;
/*角色运动速度*/
ITEM_SPACE = 8;
/*缩放*/
ZOOM = 2;
/*============触控 配置============*/
/*在这个高度之上的触控视为向上移动*/
TC_CEIL_LINE_PER = 30;
/*在这个高度之下的触控视为向下移动*/
TC_BOTTOM_LINE_PER = 60;
/*刷新操作的频率*/
TC_EXEC_FREQUENT = 40;


UP = 87;
DOWN = 83;
LEFT = 65;
RIGHT = 68;

var Player = anra.Role.extend({
    constructor:function () {
        this.actions = new Map();
        this.animations = new Map();
        this.router = new Router();
    },
    registActions:function () {
        this.actions.set(UP, new MoveAction());
        this.actions.set(DOWN, new MoveAction());
        this.actions.set(LEFT, new MoveAction());
        this.actions.set(RIGHT, new MoveAction());

        action = new WaitingAction(this);
        this.actions.set(action.id, action);
    },
    setStatus:function (status) {
        if (this.status != status && this.actions.get(status) != null) {
            var oldStatus = this.status;
            this.status = status;
            this.fireActChange({oldStatus:oldStatus, newStatus:this.status, source:this, scene:this.scene});
        }
    }
});

var Router = anra.Router.extend({
    arrived:true,
    route:function (player, keyCode) {
        var rx = player.x + player.scene.x;
        var ry = player.y + player.scene.y;
        var px = Math.floor(rx / player.scene.cellSize);
        var py = Math.floor(ry / player.scene.cellSize);
        var ix = px, iy = py;
        var dx = 0, dy = 0;
        var flag = true;
        var n, m;
        switch (keyCode) {
            case UP:
                iy = py - 1;
                dy = py * player.scene.cellSize - ry;
                break;
            case DOWN:
                iy = py + 1;
                n = Math.floor((ry + player.height) / player.scene.cellSize) + 1;
                dy = n * player.scene.cellSize - ry - player.height;
                flag = config[n][ix] == 1;
                console.log(dy);
                break;
            case LEFT:
                ix = px - 1;
                dx = px * player.scene.cellSize - rx;
                break;
            case RIGHT:
                ix = px + 1;
                m = Math.floor((rx + player.width) / player.scene.cellSize) + 1;
                dx = m * player.scene.cellSize - (rx + player.width);

                flag = config[iy][m];
                break;
        }
        var s = Math.floor(player.scene.cellSize);
        if (config[iy][ix] == 1 && flag) {
            player.scene.tx = player.scene.x + (ix - px) * player.scene.cellSize;
            player.scene.ty = player.scene.y + (iy - py) * player.scene.cellSize;
        } else if (dx < s - 4 && dy < s - 4) {
            player.scene.tx = player.scene.x + dx;
            player.scene.ty = player.scene.y + dy;
        }
//        console.log( player.scene.y+":"+player.scene.ty);
    },
    applyMove:function (x, y, tx, ty, speed) {
        return [tx, ty];
    },
    next:function (x, y, tx, ty, speed) {
        var dx = tx - x;
        var fdx = Math.abs(dx);
        if (fdx > 1) {
            x = x + fdx / dx * 2;
        } else
            x = tx;

        var dy = ty - y;
        var fdy = Math.abs(dy);
        if (fdy > 1) {
            y = y + fdy / dy * 2;
        } else
            y = ty;
        if (this.isArrived(x, y, tx, ty)) {
            this.arrived = true;
            return null;
        } else
            this.arrived = false;
        return [x, y]
    }
});

var MoveAction = anra.MoveSceneAction.extend({
    beforeRun:function (player) {
    },
    afterRun:function (player) {
        player.scene.refresh();
    }
});

var DirectionKeys = anra.DirectionKeys.extend({
    handle:function (player, keyCode) {
        if (player.router.arrived)
            player.router.route(player, keyCode);
    }
});


var WaitingAction = anra.WaitingAction.extend({
    constructor:function (player) {
    },
    run:function (player) {
    }
});

/*控制杆，使用滑动来决定操作*/
anra.OperateBar = anra.Controller.extend({
    id:"OperateBar",
    registActions:function () {
        var status = -1;
        var sp, cp;

        var canvas = anra.Platform.getDisplay();
        var target = this.target;
        this.addTouchListener(new anra.Listener(function (ev) {
            if (ev.touches.length == 1) {
                var t = ev.touches[0];
                if (ev.type == anra.EVENT.TouchStart) {
                    sp = canvas.getRelativeLocation(ev.touches[0]);
                    status = 0;
                } else if (ev.type == anra.EVENT.TouchMove) {
                    cp = canvas.getRelativeLocation(ev.touches[0]);
                    var d = anra.Rectangle.distance(sp, cp);
                    console.log(d);
                }
            }
            else if (ev.type == anra.EVENT.TouchEnd) {
                status = -1;
            }
        }));
    },
    paint:function (o, gc) {
        gc.save();
        gc.globalAlpha = 0.2;
        gc.fillStyle = 'red';
        gc.fillRect(this.x, this.y, this.width, this.height);
        gc.restore();
    }
});
